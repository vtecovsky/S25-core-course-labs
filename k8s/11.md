# Overview

# Creating Secret using kubectl

```bash
➜  ~ kubectl create secret generic my-secret \
  --from-literal=username=admin \
  --from-literal=password=admin     
secret/my-secret created
```

# Verify and Decode Your Secret

```bash
➜  ~ kubectl get secrets my-secret            
  
NAME        TYPE     DATA   AGE
my-secret   Opaque   2      2m16s
```

```bash
➜  ~ kubectl get secret my-secret -o jsonpath="{.data.password}" | base64 --decode

admin%   
```


```bash
➜  ~ kubectl get secret my-secret -o jsonpath="{.data.username}" | base64 --decode

admin%
```

# Install secrets using helm secrets

I deleted previously created secrets and create new one using helm secrets


```bash
➜  app-python git:(lab-11) ✗ helm secrets install app-python . -f secrets.yaml

NAME: app-python
LAST DEPLOYED: Sun Mar  9 14:34:20 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export NODE_PORT=$(kubectl get --namespace default -o jsonpath="{.spec.ports[0].nodePort}" services app-python)
  export NODE_IP=$(kubectl get nodes --namespace default -o jsonpath="{.items[0].status.addresses[0].address}")
  echo http://$NODE_IP:$NODE_PORT
secrets.yaml.dec
```



# Verifying secret
```bash
➜  app-python git:(lab-11) ✗ kubectl exec app-python-56f7b87b49-6g9jv -- printenv | grep MY_PASS
MY_PASSWORD=admin
```


# Vault secrets

## Setup
```bash
➜  app-python git:(lab-11) ✗ kubectl exec -it vault-0 -- /bin/sh
/ $ vault secrets enable -path=internal kv-v2
Success! Enabled the kv-v2 secrets engine at: internal/
/ $ vault kv put internal/database/config username="db-readonly-username" password="db-secret-password"
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-09T12:22:23.504700858Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1
/ $ vault kv get internal/database/config
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-09T12:22:23.504700858Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
password    db-secret-password
username    db-readonly-username
```



## Verifying keys existence

I have created new service account named internal-app according to the provided instructions, specify this service account settings in values.yaml
```bash
➜  app-python git:(lab-11) ✗ kubectl exec -it app-python-5549bcc99f-jgxcb  --container app-python -- /bin/sh 
$ ls
src  venv
$ cd ..
$ ls
app  bin  boot  dev  etc  home  lib  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var  vault
$ cat vault/secrets/database-config.txt
data: map[password:db-secret-password username:db-readonly-username]
metadata: map[created_time:2025-03-09T12:22:23.504700858Z custom_metadata:<nil> deletion_time: destroyed:false version:1]
$ 
```

## Applying template
```bash
➜  app-python git:(lab-11) ✗ kubectl patch deployment app-python --patch-file=patch.yaml
deployment.apps/app-python patched
```

As we see, new postgres dsn was updated to new database

```bash
➜  app-python git:(lab-11) ✗ kubectl exec -it app-python-66f989b6b6-s4k45  --container app-python -- /bin/sh
$ cd ..
$ ls
app  bin  boot  dev  etc  home  lib  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var  vault
$ cat vault/secrets/database-config.txt
postgresql://db-readonly-username:db-secret-password@postgres:5432/newdb$ exit
```

# Bonus task: resource management

New resources were applied.
## Resources
```bash
➜  app-python git:(lab-11) ✗ helm upgrade --install app-python . -f secrets.yaml                             

Release "app-python" has been upgraded. Happy Helming!
NAME: app-python
LAST DEPLOYED: Sun Mar  9 16:11:54 2025
NAMESPACE: default
STATUS: deployed
REVISION: 3
NOTES:
1. Get the application URL by running these commands:
  export NODE_PORT=$(kubectl get --namespace default -o jsonpath="{.spec.ports[0].nodePort}" services app-python)
  export NODE_IP=$(kubectl get nodes --namespace default -o jsonpath="{.items[0].status.addresses[0].address}")
  echo http://$NODE_IP:$NODE_PORT
➜  app-python git:(lab-11) ✗ kubectl describe deployments.apps app-python 
Name:                   app-python
Namespace:              default
CreationTimestamp:      Sun, 09 Mar 2025 14:34:45 +0300
Labels:                 app.kubernetes.io/instance=app-python
                        app.kubernetes.io/managed-by=Helm
                        app.kubernetes.io/name=app-python
                        app.kubernetes.io/version=1.16.0
                        helm.sh/chart=app-python-0.1.0
Annotations:            deployment.kubernetes.io/revision: 4
                        meta.helm.sh/release-name: app-python
                        meta.helm.sh/release-namespace: default
Selector:               app.kubernetes.io/instance=app-python,app.kubernetes.io/name=app-python
Replicas:               1 desired | 1 updated | 1 total | 1 available | 0 unavailable
StrategyType:           RollingUpdate
MinReadySeconds:        0
RollingUpdateStrategy:  25% max unavailable, 25% max surge
Pod Template:
  Labels:           app.kubernetes.io/instance=app-python
                    app.kubernetes.io/managed-by=Helm
                    app.kubernetes.io/name=app-python
                    app.kubernetes.io/version=1.16.0
                    helm.sh/chart=app-python-0.1.0
  Annotations:      vault.hashicorp.com/agent-inject: true
                    vault.hashicorp.com/agent-inject-secret-database-config.txt: internal/data/database/config
                    vault.hashicorp.com/agent-inject-status: update
                    vault.hashicorp.com/agent-inject-template-database-config.txt:
                      {{- with secret "internal/data/database/config" -}}
                      postgresql://{{ .Data.data.username }}:{{ .Data.data.password }}@postgres:5432/newdb
                      {{- end -}}
                    vault.hashicorp.com/role: internal-app
  Service Account:  internal-app
  Containers:
   app-python:
    Image:      vtecovsky/app_python:latest
    Port:       8000/TCP
    Host Port:  0/TCP
    Limits:
      cpu:     100m
      memory:  128Mi
    Requests:
      cpu:     100m
      memory:  128Mi
    Environment:
      MY_PASSWORD:  <set to the key 'password' in secret 'my-secret'>  Optional: false
    Mounts:         <none>
  Volumes:          <none>
Conditions:
  Type           Status  Reason
  ----           ------  ------
  Available      True    MinimumReplicasAvailable
  Progressing    True    NewReplicaSetAvailable
OldReplicaSets:  app-python-56f7b87b49 (0/0 replicas created), app-python-5549bcc99f (0/0 replicas created), app-python-66f989b6b6 (0/0 replicas created)
NewReplicaSet:   app-python-5f5fdb9f8b (1/1 replicas created)
Events:
  Type    Reason             Age   From                   Message
  ----    ------             ----  ----                   -------
  Normal  ScalingReplicaSet  36m   deployment-controller  Scaled up replica set app-python-5549bcc99f to 1
  Normal  ScalingReplicaSet  36m   deployment-controller  Scaled down replica set app-python-56f7b87b49 to 0 from 1
  Normal  ScalingReplicaSet  6m8s  deployment-controller  Scaled up replica set app-python-66f989b6b6 to 1
  Normal  ScalingReplicaSet  6m6s  deployment-controller  Scaled down replica set app-python-5549bcc99f to 0 from 1
  Normal  ScalingReplicaSet  17s   deployment-controller  Scaled up replica set app-python-5f5fdb9f8b to 1
  Normal  ScalingReplicaSet  14s   deployment-controller  Scaled down replica set app-python-66f989b6b6 to 0 from 1
  ```


  ## Environments
  DUMMY_ENV is listed below:)
  ```bash
  ➜  app-python git:(lab-11) ✗ kubectl exec app-python-dfb78947d-lg7tk  -- printenv

Defaulted container "app-python" out of: app-python, vault-agent, vault-agent-init (init)
PATH=/app/venv/bin:/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
HOSTNAME=app-python-dfb78947d-lg7tk
DUMMY_ENV=SOME_DUMMY_ENV
MY_PASSWORD=ENC[AES256_GCM,data:YvhdotQ=,iv:El0TSRngDvC0IrMJUPsDWcnYkwIQbGs4KN0icV62yPs=,tag:DWn+n9w0caMx1ecK4NVN4Q==,type:str]
HELM_HOOKS_APP_PYTHON_PORT_8000_TCP_ADDR=10.99.98.39
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP_ADDR=10.105.47.76
APP_PYTHON_PORT_8000_TCP_PROTO=tcp
VAULT_PORT_8201_TCP_ADDR=10.98.120.70
VAULT_AGENT_INJECTOR_SVC_SERVICE_PORT=443
KUBERNETES_PORT_443_TCP_PROTO=tcp
VAULT_PORT_8201_TCP=tcp://10.98.120.70:8201
APP_PYTHON_RELEASE_SERVICE_HOST=10.105.15.120
APP_PYTHON_SERVICE_HOST=10.108.206.149
KUBERNETES_PORT=tcp://10.96.0.1:443
VAULT_PORT_8200_TCP_PORT=8200
VAULT_PORT_8201_TCP_PORT=8201
APP_PYTHON_SERVICE_PORT=8000
HELM_HOOKS_APP_PYTHON_SERVICE_HOST=10.99.98.39
VAULT_SERVICE_PORT=8200
VAULT_PORT=tcp://10.98.120.70:8200
APP_PYTHON_PORT_8000_TCP=tcp://10.108.206.149:8000
VAULT_SERVICE_PORT_HTTP=8200
VAULT_SERVICE_PORT_HTTPS_INTERNAL=8201
VAULT_PORT_8201_TCP_PROTO=tcp
HELM_HOOKS_APP_PYTHON_PORT_8000_TCP=tcp://10.99.98.39:8000
KUBERNETES_SERVICE_PORT_HTTPS=443
APP_PYTHON_RELEASE_PORT_8000_TCP_PORT=8000
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP_PROTO=tcp
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP_PORT=443
APP_PYTHON_RELEASE_PORT=tcp://10.105.15.120:8000
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP=tcp://10.105.47.76:443
APP_PYTHON_PORT_8000_TCP_PORT=8000
HELM_HOOKS_APP_PYTHON_PORT_8000_TCP_PROTO=tcp
VAULT_SERVICE_HOST=10.98.120.70
VAULT_PORT_8200_TCP=tcp://10.98.120.70:8200
APP_PYTHON_RELEASE_PORT_8000_TCP_PROTO=tcp
KUBERNETES_PORT_443_TCP_PORT=443
VAULT_PORT_8200_TCP_PROTO=tcp
APP_PYTHON_RELEASE_SERVICE_PORT_HTTP=8000
HELM_HOOKS_APP_PYTHON_PORT_8000_TCP_PORT=8000
KUBERNETES_PORT_443_TCP_ADDR=10.96.0.1
VAULT_PORT_8200_TCP_ADDR=10.98.120.70
APP_PYTHON_RELEASE_PORT_8000_TCP=tcp://10.105.15.120:8000
VAULT_AGENT_INJECTOR_SVC_PORT=tcp://10.105.47.76:443
APP_PYTHON_SERVICE_PORT_HTTP=8000
APP_PYTHON_RELEASE_SERVICE_PORT=8000
VAULT_AGENT_INJECTOR_SVC_SERVICE_PORT_HTTPS=443
APP_PYTHON_PORT=tcp://10.108.206.149:8000
KUBERNETES_SERVICE_HOST=10.96.0.1
KUBERNETES_SERVICE_PORT=443
APP_PYTHON_PORT_8000_TCP_ADDR=10.108.206.149
HELM_HOOKS_APP_PYTHON_SERVICE_PORT=8000
HELM_HOOKS_APP_PYTHON_SERVICE_PORT_HTTP=8000
HELM_HOOKS_APP_PYTHON_PORT=tcp://10.99.98.39:8000
KUBERNETES_PORT_443_TCP=tcp://10.96.0.1:443
APP_PYTHON_RELEASE_PORT_8000_TCP_ADDR=10.105.15.120
VAULT_AGENT_INJECTOR_SVC_SERVICE_HOST=10.105.47.76
LANG=C.UTF-8
GPG_KEY=7169605F62C751356D054A26A821E680E5FA6305
PYTHON_VERSION=3.12.9
PYTHON_SHA256=7220835d9f90b37c006e9842a8dff4580aaca4318674f947302b8d28f3f81112
PYTHONUNBUFFERED=1
PYTHONDONTWRITEBYTECODE=1
HOME=/home/python_user
```

## Template file for ENVS

I specifed some envs in _helpers.tpl and also changed deployment.yaml file to sync these envs. We can see new envs below.

```bash
➜  app-python git:(lab-11) ✗ kubectl exec app-python-c8b66f6c8-46t2z  -- printenv

Defaulted container "app-python" out of: app-python, vault-agent, vault-agent-init (init)
PATH=/app/venv/bin:/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
HOSTNAME=app-python-c8b66f6c8-46t2z
DUMMY_ENV_FROM_TEMPLATE=DUMMY_ENV_FROM_TEMPLATE
ANOTHER_ENV=ANOTHER_VALUE
MY_PASSWORD=ENC[AES256_GCM,data:YvhdotQ=,iv:El0TSRngDvC0IrMJUPsDWcnYkwIQbGs4KN0icV62yPs=,tag:DWn+n9w0caMx1ecK4NVN4Q==,type:str]
DUMMY_ENV=SOME_DUMMY_ENV
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP_PROTO=tcp
KUBERNETES_PORT=tcp://10.96.0.1:443
VAULT_PORT_8200_TCP=tcp://10.98.120.70:8200
APP_PYTHON_PORT_8000_TCP_PROTO=tcp
VAULT_PORT_8201_TCP_ADDR=10.98.120.70
APP_PYTHON_RELEASE_PORT=tcp://10.105.15.120:8000
APP_PYTHON_RELEASE_PORT_8000_TCP_PROTO=tcp
VAULT_PORT=tcp://10.98.120.70:8200
VAULT_PORT_8200_TCP_PORT=8200
APP_PYTHON_SERVICE_PORT_HTTP=8000
APP_PYTHON_SERVICE_PORT=8000
HELM_HOOKS_APP_PYTHON_SERVICE_PORT=8000
HELM_HOOKS_APP_PYTHON_PORT_8000_TCP_ADDR=10.99.98.39
VAULT_SERVICE_HOST=10.98.120.70
KUBERNETES_PORT_443_TCP_PROTO=tcp
APP_PYTHON_PORT_8000_TCP_PORT=8000
VAULT_AGENT_INJECTOR_SVC_PORT=tcp://10.105.47.76:443
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP_PORT=443
HELM_HOOKS_APP_PYTHON_PORT=tcp://10.99.98.39:8000
APP_PYTHON_RELEASE_PORT_8000_TCP=tcp://10.105.15.120:8000
VAULT_AGENT_INJECTOR_SVC_SERVICE_HOST=10.105.47.76
APP_PYTHON_PORT_8000_TCP=tcp://10.108.206.149:8000
HELM_HOOKS_APP_PYTHON_PORT_8000_TCP=tcp://10.99.98.39:8000
APP_PYTHON_RELEASE_SERVICE_PORT=8000
VAULT_AGENT_INJECTOR_SVC_SERVICE_PORT=443
APP_PYTHON_RELEASE_SERVICE_HOST=10.105.15.120
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP_ADDR=10.105.47.76
APP_PYTHON_PORT=tcp://10.108.206.149:8000
HELM_HOOKS_APP_PYTHON_PORT_8000_TCP_PORT=8000
VAULT_SERVICE_PORT_HTTPS_INTERNAL=8201
VAULT_PORT_8201_TCP_PROTO=tcp
APP_PYTHON_RELEASE_SERVICE_PORT_HTTP=8000
HELM_HOOKS_APP_PYTHON_PORT_8000_TCP_PROTO=tcp
KUBERNETES_PORT_443_TCP_PORT=443
KUBERNETES_PORT_443_TCP_ADDR=10.96.0.1
KUBERNETES_SERVICE_PORT_HTTPS=443
VAULT_SERVICE_PORT_HTTP=8200
VAULT_PORT_8200_TCP_PROTO=tcp
KUBERNETES_SERVICE_HOST=10.96.0.1
APP_PYTHON_SERVICE_HOST=10.108.206.149
HELM_HOOKS_APP_PYTHON_SERVICE_HOST=10.99.98.39
HELM_HOOKS_APP_PYTHON_SERVICE_PORT_HTTP=8000
VAULT_AGENT_INJECTOR_SVC_SERVICE_PORT_HTTPS=443
KUBERNETES_PORT_443_TCP=tcp://10.96.0.1:443
VAULT_SERVICE_PORT=8200
VAULT_PORT_8200_TCP_ADDR=10.98.120.70
VAULT_PORT_8201_TCP_PORT=8201
APP_PYTHON_RELEASE_PORT_8000_TCP_PORT=8000
APP_PYTHON_RELEASE_PORT_8000_TCP_ADDR=10.105.15.120
APP_PYTHON_PORT_8000_TCP_ADDR=10.108.206.149
VAULT_PORT_8201_TCP=tcp://10.98.120.70:8201
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP=tcp://10.105.47.76:443
KUBERNETES_SERVICE_PORT=443
LANG=C.UTF-8
GPG_KEY=7169605F62C751356D054A26A821E680E5FA6305
PYTHON_VERSION=3.12.9
PYTHON_SHA256=7220835d9f90b37c006e9842a8dff4580aaca4318674f947302b8d28f3f81112
PYTHONUNBUFFERED=1
PYTHONDONTWRITEBYTECODE=1
HOME=/home/python_user
```