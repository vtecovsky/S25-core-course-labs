### Components of Kube Prometheus Stack

The Kube Prometheus Stack is a collection of Kubernetes manifests, Grafana dashboards, and Prometheus rules that provide a comprehensive monitoring solution for Kubernetes clusters. Here are the main components and their roles:

1. **Prometheus**:

   - Core time-series database that collects and stores metrics
   - Responsible for scraping metrics endpoints from various sources
   - Implements a powerful query language (PromQL) for data analysis
   - Provides alerting capabilities based on metric thresholds

2. **Alertmanager**:

   - Handles alerts sent by Prometheus
   - Deduplicates, groups, and routes alerts to the correct receiver
   - Supports various notification methods (email, Slack, PagerDuty, etc.)
   - Implements silencing and inhibition mechanisms to reduce alert noise

3. **Grafana**:

   - Visualization platform for metrics and logs
   - Provides customizable dashboards with various visualization types
   - Supports multiple data sources, including Prometheus
   - Allows for setting up alerts based on visualized metrics

4. **Node Exporter**:

   - Collects hardware and OS-level metrics from nodes
   - Exposes system metrics like CPU, memory, disk, and network usage
   - Runs as a DaemonSet to ensure coverage on all nodes

5. **kube-state-metrics**:

   - Generates metrics about the state of Kubernetes objects
   - Monitors deployments, pods, nodes, and other resources
   - Complements the metrics provided by Kubelet

6. **Prometheus Operator**:

   - Manages Prometheus instances
   - Creates, configures, and manages Prometheus monitoring stacks
   - Simplifies the deployment and configuration of Prometheus
   - Manages ServiceMonitors and PodMonitors for automatic service discovery

7. **ServiceMonitor and PodMonitor**:

   - Custom resources that define how services and pods should be monitored
   - Allow for declarative configuration of scrape targets
   - Enable automatic discovery of services to monitor

8. **PrometheusRule**:
   - Custom resource for defining alerting and recording rules
   - Allows for declarative management of Prometheus rules


```bash
âžœ  ~ kubectl get po,sts,svc,pvc,cm
NAME                                                         READY   STATUS             RESTARTS      AGE
pod/alertmanager-monitoring-kube-prometheus-alertmanager-0   2/2     Running            0             3m43s
pod/app-python-0                                             1/1     Running            0             3m16s
pod/app-python-1                                             1/1     Running            1             3m16s
pod/app-python-post-install-r5xw9                            0/1     Completed          0             3m16s
pod/app-python-pre-install-862ct                             0/1     Completed          0             4m13s
pod/monitoring-grafana-8579bfbb94-bqq6k                      3/3     Running            0             4m49s
pod/monitoring-kube-prometheus-operator-68db854bd4-tm6sg     1/1     Running            0             4m49s
pod/monitoring-kube-state-metrics-68655f7fdc-pjtjx           1/1     Running            0             4m49s
pod/monitoring-prometheus-node-exporter-t22l8                1/1     Running            0             4m49s
pod/prometheus-monitoring-kube-prometheus-prometheus-0       2/2     Running            0             3m43s

NAME                                                                    READY   AGE
statefulset.apps/alertmanager-monitoring-kube-prometheus-alertmanager   1/1     3m43s
statefulset.apps/app-python                                             2/2     3m16s
statefulset.apps/prometheus-monitoring-kube-prometheus-prometheus       1/1     3m43s

NAME                                              TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE
service/alertmanager-operated                     ClusterIP   None             <none>        9093/TCP,9094/TCP,9094/UDP   3m43s
service/app-python                                NodePort    10.97.24.246     <none>        8000:31984/TCP               3m16s
service/kubernetes                                ClusterIP   10.96.0.1        <none>        443/TCP                      5m31s
service/monitoring-grafana                        ClusterIP   10.106.165.65    <none>        80/TCP                       4m49s
service/monitoring-kube-prometheus-alertmanager   ClusterIP   10.106.159.100   <none>        9093/TCP,8080/TCP            4m49s
service/monitoring-kube-prometheus-operator       ClusterIP   10.100.189.198   <none>        443/TCP                      4m49s
service/monitoring-kube-prometheus-prometheus     ClusterIP   10.98.161.172    <none>        9090/TCP,8080/TCP            4m49s
service/monitoring-kube-state-metrics             ClusterIP   10.107.209.9     <none>        8080/TCP                     4m49s
service/monitoring-prometheus-node-exporter       ClusterIP   10.103.43.85     <none>        9100/TCP                     4m49s
service/prometheus-operated                       ClusterIP   None             <none>        9090/TCP                     3m43s

NAME                                             STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
persistentvolumeclaim/data-volume-app-python-0   Bound    pvc-8923e7f2-ab09-43ca-a566-64588e362f4b   128Mi      RWO            standard       3m16s
persistentvolumeclaim/data-volume-app-python-1   Bound    pvc-67a50c8d-4efa-41ee-8eac-16771ea5f4b4   128Mi      RWO            standard       3m16s

NAME                                                                     DATA   AGE
configmap/demo-config                                                    1      3m16s
configmap/kube-root-ca.crt                                               1      5m16s
configmap/monitoring-grafana                                             1      4m49s
configmap/monitoring-grafana-config-dashboards                           1      4m49s
configmap/monitoring-kube-prometheus-alertmanager-overview               1      4m49s
configmap/monitoring-kube-prometheus-apiserver                           1      4m49s
configmap/monitoring-kube-prometheus-cluster-total                       1      4m49s
configmap/monitoring-kube-prometheus-controller-manager                  1      4m49s
configmap/monitoring-kube-prometheus-etcd                                1      4m49s
configmap/monitoring-kube-prometheus-grafana-datasource                  1      4m49s
configmap/monitoring-kube-prometheus-grafana-overview                    1      4m49s
configmap/monitoring-kube-prometheus-k8s-coredns                         1      4m49s
configmap/monitoring-kube-prometheus-k8s-resources-cluster               1      4m49s
configmap/monitoring-kube-prometheus-k8s-resources-multicluster          1      4m49s
configmap/monitoring-kube-prometheus-k8s-resources-namespace             1      4m49s
configmap/monitoring-kube-prometheus-k8s-resources-node                  1      4m49s
configmap/monitoring-kube-prometheus-k8s-resources-pod                   1      4m49s
configmap/monitoring-kube-prometheus-k8s-resources-workload              1      4m49s
configmap/monitoring-kube-prometheus-k8s-resources-workloads-namespace   1      4m49s
configmap/monitoring-kube-prometheus-kubelet                             1      4m49s
configmap/monitoring-kube-prometheus-namespace-by-pod                    1      4m49s
configmap/monitoring-kube-prometheus-namespace-by-workload               1      4m49s
configmap/monitoring-kube-prometheus-node-cluster-rsrc-use               1      4m49s
configmap/monitoring-kube-prometheus-node-rsrc-use                       1      4m49s
configmap/monitoring-kube-prometheus-nodes                               1      4m49s
configmap/monitoring-kube-prometheus-nodes-darwin                        1      4m49s
configmap/monitoring-kube-prometheus-persistentvolumesusage              1      4m49s
configmap/monitoring-kube-prometheus-pod-total                           1      4m49s
configmap/monitoring-kube-prometheus-prometheus                          1      4m49s
configmap/monitoring-kube-prometheus-proxy                               1      4m49s
configmap/monitoring-kube-prometheus-scheduler                           1      4m49s
configmap/monitoring-kube-prometheus-workload-total                      1      4m49s
configmap/prometheus-monitoring-kube-prometheus-prometheus-rulefiles-0   35     3m43s
```

Explanation of the output:

- **Pods (po)**: Running instances of our application containers. We have pods for both our Python application and monitoring components like Prometheus, Alertmanager, and Grafana.

- **StatefulSets (sts)**: Designed for stateful applications that require stable network identities and persistent storage. Our Python app is deployed as a StatefulSet to ensure persistent storage for visit counts.

- **Services (svc)**: Network abstractions that expose pods to the network. Services such as prometheus-operated, alertmanager-operated, and python-app provide access to the respective components.

- **Persistent Volume Claims (pvc)**: Storage resources requested by pods. Both our Python app and monitoring components utilize PVCs for persistent data storage.

- **ConfigMaps (cm)**: Used to store non-sensitive configuration data. Various ConfigMaps are employed to configure Prometheus, Grafana, and other components.

### Grafana Dashboard Overview

1. **CPU and Memory Usage of the Python App StatefulSet**:

   - The Python app StatefulSet exhibits an average CPU usage of about 1% and memory consumption ranging from 15-40 MB, which is typical for a lightweight Python FastAPI application.

2. **Pods with the Highest and Lowest CPU Usage in the Default Namespace**:

   - **Highest CPU Usage**: The Prometheus pod (prometheus-monitoring-kube-prometheus-prometheus-0) shows higher CPU usage (approximately 4%) due to continuous metrics collection and processing.
   - **Lowest CPU Usage**: The Python app pod (python-app-0) has lower CPU usage (around 1%), as it's a lightweight application that processes requests only when accessed.

3. **Node Memory Usage**:

   - **Memory Usage Percentage**: The Minikube node consumes 30-50% of its allocated memory while running the Kube Prometheus Stack and the Python application.
   - **Memory Usage in Megabytes**: 1-1.4 GB.

4. **Number of Pods and Containers Managed by Kubelet**:

   - **Total Pods**: 15
   - **Total Containers**: 26

5. **Network Usage of Pods in the Default Namespace**:

   - **Highest Network Usage**: The Prometheus pod has the highest network usage, with 6.47 kB/s transmitted and 2.66 kB/s received, due to continuous metrics collection.
   - **Total Network Traffic**: 33.5 kB/s transmitted and 19.6 kB/s received.

6. **Active Alerts**:

   - **Total Active Alerts**: 11
   - **Critical Alerts**: 4
   - **Warning Alerts**: 6

## Init containers

I created the following lines of code in statefulset.yaml

```
initContainers:
- name: init-container
    image: busybox
    command: ["sh", "-c", "echo 'Init Container running' && sleep 10"]
    volumeMounts:
    - name: app-volume
        mountPath: /data
```

```bash
kubectl exec pod/app-python-0 -- cat /data/test.html
```

Output:

```
Defaulted container "app-python" out of: app-python, init-download (init), init-first (init), init-second (init), init-third (init)
<HEADER>
<TITLE>The World Wide Web project</TITLE>
<NEXTID N="55">
</HEADER>
<BODY>
<H1>World Wide Web</H1>The WorldWideWeb (W3) is a wide-area<A
NAME=0 HREF="WhatIs.html">
hypermedia</A> information retrieval
initiative aiming to give universal
access to a large universe of documents.<P>
```
