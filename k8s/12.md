# ConfigMap

I have created configmap.yaml inside templates/ dir and mount it to the deployment

```bash
➜  app-python git:(lab-12) ✗ kubectl get configmaps
NAME               DATA   AGE
demo-config        1      2m5s
```

```bash
➜  app-python git:(lab-12) ✗ kubectl describe configmaps demo-config
Name:         demo-config
Namespace:    default
Labels:       app.kubernetes.io/managed-by=Helm
Annotations:  meta.helm.sh/release-name: app-python
              meta.helm.sh/release-namespace: default

Data
====
config.json:
----

{
    "key": "value"
}

BinaryData
====

Events:  <none>
```

Pods info
```bash
➜  app-python git:(lab-12) ✗ k get pods
NAME                                  READY   STATUS      RESTARTS   AGE
app-python-ddc6c48b8-9mnc8            1/1     Running     0          36s
app-python-post-install-ps69d         0/1     Completed   0          19m
app-python-pre-install-4nfrz          0/1     Completed   0          19m
app-python-release-7865995874-mcr9m   1/1     Running     0          16m
helm-hooks-pre-install-qb7nn          0/1     Completed   0          12d
vault-0                               1/1     Running     0          16m
```


```bash
➜ app-python git:(lab-12) ✗ k describe pod app-python-77fc449db7-s9jm7
Name:             app-python-77fc449db7-s9jm7
Namespace:        default
Priority:         0
Service Account:  internal-app
Node:             minikube/192.168.49.2
Start Time:       Sun, 09 Mar 2025 22:33:22 +0300
Labels:           app.kubernetes.io/instance=app-python
                  app.kubernetes.io/managed-by=Helm
                  app.kubernetes.io/name=app-python
                  app.kubernetes.io/version=1.16.0
                  helm.sh/chart=app-python-0.1.0
                  pod-template-hash=77fc449db7
Annotations:      vault.hashicorp.com/agent-inject: true
                  vault.hashicorp.com/agent-inject-secret-database-config.txt: internal/data/database/config
                  vault.hashicorp.com/role: internal-app
Status:           Running
IP:               10.244.0.72
IPs:
  IP:           10.244.0.72
Controlled By:  ReplicaSet/app-python-77fc449db7
Containers:
  app-python:
    Container ID:   docker://43641474a0d64d3813bccac9ee22c8c03fcf4fb3e540727fd057c3dc0b039e99
    Image:          vtecovsky/app_python:latest
    Image ID:       docker-pullable://vtecovsky/app_python@sha256:57eac0df1a1b3833e0f4d468dee0395a7e643e302677afeff82364067009564d
    Port:           8000/TCP
    Host Port:      0/TCP
    State:          Running
      Started:      Sun, 09 Mar 2025 22:33:23 +0300
    Ready:          True
    Restart Count:  0
    Limits:
      cpu:     100m
      memory:  128Mi
    Requests:
      cpu:     100m
      memory:  128Mi
    Environment Variables from:
      demo-config  ConfigMap  Optional: false
    Environment:
      DUMMY_ENV_FROM_TEMPLATE:  DUMMY_ENV_FROM_TEMPLATE
      ANOTHER_ENV:              ANOTHER_VALUE
      MY_PASSWORD:              <set to the key 'password' in secret 'my-secret'>  Optional: false
      DUMMY_ENV:                SOME_DUMMY_ENV
    Mounts:
      /data/config.json from config-volume (ro,path="config.json")
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-82fkq (ro)
Conditions:
  Type              Status
  Initialized       True 
  Ready             True 
  ContainersReady   True 
  PodScheduled      True 
Volumes:
  config-volume:
    Type:      ConfigMap (a volume populated by a ConfigMap)
    Name:      demo-config
    Optional:  false
  kube-api-access-82fkq:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   Guaranteed
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age    From               Message
  ----    ------     ----   ----               -------
  Normal  Scheduled  3m24s  default-scheduler  Successfully assigned default/app-python-77fc449db7-s9jm7 to minikube
  Normal  Pulled     3m23s  kubelet            Container image "vtecovsky/app_python:latest" already present on machine
  Normal  Created    3m23s  kubelet            Created container app-python
  Normal  Started    3m23s  kubelet            Started container app-python
```


Check mount file existence:
```bash
➜  app-python git:(lab-12) ✗ kubectl exec app-python-77fc449db7-s9jm7 -- cat /data/config.json

{
    "key": "value"
}%           
```

## The same persistence for another application (bonus task)
```bash
➜  app-golang git:(lab-12) ✗ k get pods
NAME                                  READY   STATUS      RESTARTS   AGE
app-go-app-golang-f6c88c544-7fw95     1/1     Running     0          70s
app-python-77fc449db7-s9jm7           1/1     Running     0          15m
app-python-post-install-ps69d         0/1     Completed   0          44m
app-python-pre-install-4nfrz          0/1     Completed   0          44m
app-python-release-7865995874-mcr9m   1/1     Running     0          41m
helm-hooks-pre-install-qb7nn          0/1     Completed   0          12d
vault-0                               1/1     Running     0          41m
```

```bash
➜ app-golang git:(lab-12) ✗ k describe pod app-go-app-golang-f6c88c544-7fw95
Name:             app-go-app-golang-f6c88c544-7fw95
Namespace:        default
Priority:         0
Service Account:  app-go-app-golang
Node:             minikube/192.168.49.2
Start Time:       Sun, 09 Mar 2025 22:47:57 +0300
Labels:           app.kubernetes.io/instance=app-go
                  app.kubernetes.io/managed-by=Helm
                  app.kubernetes.io/name=app-golang
                  app.kubernetes.io/version=1.16.0
                  helm.sh/chart=app-golang-0.1.0
                  pod-template-hash=f6c88c544
Annotations:      <none>
Status:           Running
IP:               10.244.0.75
IPs:
  IP:           10.244.0.75
Controlled By:  ReplicaSet/app-go-app-golang-f6c88c544
Containers:
  app-golang:
    Container ID:   docker://09dcb671e88aaee490d1b9ac28f1d086cb68a99365aca0de501a379a863f0d8a
    Image:          vtecovsky/app_golang:latest
    Image ID:       docker-pullable://vtecovsky/app_golang@sha256:266c3a6ce7a1199eab502cc18b50eb6c9b41e67f874c0eff12264311499784d5
    Port:           8080/TCP
    Host Port:      0/TCP
    State:          Running
      Started:      Sun, 09 Mar 2025 22:47:57 +0300
    Ready:          True
    Restart Count:  0
    Limits:
      cpu:     100m
      memory:  128Mi
    Requests:
      cpu:        100m
      memory:     128Mi
    Environment:  <none>
    Mounts:
      /data/config.json from config-volume (ro,path="config.json")
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-wqlvk (ro)
Conditions:
  Type              Status
  Initialized       True 
  Ready             True 
  ContainersReady   True 
  PodScheduled      True 
Volumes:
  config-volume:
    Type:      ConfigMap (a volume populated by a ConfigMap)
    Name:      go-config
    Optional:  false
  kube-api-access-wqlvk:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   Guaranteed
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age   From               Message
  ----    ------     ----  ----               -------
  Normal  Scheduled  106s  default-scheduler  Successfully assigned default/app-go-app-golang-f6c88c544-7fw95 to minikube
  Normal  Pulled     106s  kubelet            Container image "vtecovsky/app_golang:latest" already present on machine
  Normal  Created    106s  kubelet            Created container app-golang
  Normal  Started    106s  kubelet            Started container app-golang
```

## ConfigMap via Environment Variables

```bash
➜  app-golang git:(lab-12) ✗ kubectl exec -it app-python-77fc449db7-s9jm7 -- /bin/sh

$ env
VAULT_PORT_8201_TCP_PROTO=tcp
APP_PYTHON_PORT=tcp://10.98.74.45:8000
APP_PYTHON_SERVICE_PORT=8000
VAULT_SERVICE_HOST=10.98.120.70
KUBERNETES_PORT=tcp://10.96.0.1:443
KUBERNETES_SERVICE_PORT=443
HELM_HOOKS_APP_PYTHON_SERVICE_HOST=10.99.98.39
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP_PORT=443
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP_PROTO=tcp
HOSTNAME=app-python-77fc449db7-s9jm7
HELM_HOOKS_APP_PYTHON_PORT_8000_TCP=tcp://10.99.98.39:8000
HOME=/home/python_user
VAULT_PORT_8200_TCP=tcp://10.98.120.70:8200
VAULT_SERVICE_PORT=8200
VAULT_PORT_8201_TCP=tcp://10.98.120.70:8201
APP_PYTHON_RELEASE_PORT_8000_TCP_ADDR=10.105.15.120
VAULT_PORT=tcp://10.98.120.70:8200
PYTHONUNBUFFERED=1
HELM_HOOKS_APP_PYTHON_SERVICE_PORT=8000
HELM_HOOKS_APP_PYTHON_PORT=tcp://10.99.98.39:8000
APP_PYTHON_RELEASE_SERVICE_PORT_HTTP=8000
GPG_KEY=7169605F62C751356D054A26A821E680E5FA6305
VAULT_AGENT_INJECTOR_SVC_SERVICE_PORT_HTTPS=443
APP_PYTHON_RELEASE_PORT_8000_TCP_PORT=8000
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP=tcp://10.105.47.76:443
PYTHON_SHA256=7220835d9f90b37c006e9842a8dff4580aaca4318674f947302b8d28f3f81112
APP_PYTHON_RELEASE_PORT_8000_TCP_PROTO=tcp
VAULT_AGENT_INJECTOR_SVC_SERVICE_HOST=10.105.47.76
MY_PASSWORD=ENC[AES256_GCM,data:YvhdotQ=,iv:El0TSRngDvC0IrMJUPsDWcnYkwIQbGs4KN0icV62yPs=,tag:DWn+n9w0caMx1ecK4NVN4Q==,type:str]
PYTHONDONTWRITEBYTECODE=1
APP_PYTHON_RELEASE_SERVICE_HOST=10.105.15.120
TERM=xterm
DUMMY_ENV=SOME_DUMMY_ENV
KUBERNETES_PORT_443_TCP_ADDR=10.96.0.1
VAULT_AGENT_INJECTOR_SVC_SERVICE_PORT=443
VAULT_AGENT_INJECTOR_SVC_PORT=tcp://10.105.47.76:443
APP_PYTHON_RELEASE_PORT_8000_TCP=tcp://10.105.15.120:8000
PATH=/app/venv/bin:/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
KUBERNETES_PORT_443_TCP_PORT=443
KUBERNETES_PORT_443_TCP_PROTO=tcp
APP_PYTHON_RELEASE_PORT=tcp://10.105.15.120:8000
APP_PYTHON_RELEASE_SERVICE_PORT=8000
APP_PYTHON_PORT_8000_TCP_ADDR=10.98.74.45
LANG=C.UTF-8
ANOTHER_ENV=ANOTHER_VALUE
APP_PYTHON_SERVICE_PORT_HTTP=8000
APP_PYTHON_PORT_8000_TCP_PORT=8000
DUMMY_ENV_FROM_TEMPLATE=DUMMY_ENV_FROM_TEMPLATE
APP_PYTHON_PORT_8000_TCP_PROTO=tcp
PYTHON_VERSION=3.12.9
KUBERNETES_PORT_443_TCP=tcp://10.96.0.1:443
KUBERNETES_SERVICE_PORT_HTTPS=443
APP_PYTHON_SERVICE_HOST=10.98.74.45
HELM_HOOKS_APP_PYTHON_PORT_8000_TCP_ADDR=10.99.98.39
VAULT_SERVICE_PORT_HTTP=8200
KUBERNETES_SERVICE_HOST=10.96.0.1
PWD=/app
HELM_HOOKS_APP_PYTHON_SERVICE_PORT_HTTP=8000
VAULT_PORT_8200_TCP_ADDR=10.98.120.70
VAULT_PORT_8201_TCP_ADDR=10.98.120.70
HELM_HOOKS_APP_PYTHON_PORT_8000_TCP_PORT=8000
APP_PYTHON_PORT_8000_TCP=tcp://10.98.74.45:8000
VAULT_SERVICE_PORT_HTTPS_INTERNAL=8201
HELM_HOOKS_APP_PYTHON_PORT_8000_TCP_PROTO=tcp
VAULT_PORT_8200_TCP_PORT=8200
VAULT_PORT_8200_TCP_PROTO=tcp
VAULT_PORT_8201_TCP_PORT=8201
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP_ADDR=10.105.47.76
```